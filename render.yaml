services:
  # Dispatch Center Service (主服务)
  - type: web
    name: logistics-dispatch-center
    env: python
    region: oregon
    plan: free
    rootDir: applications/scheduler
    # Render 会自动读取 apt.txt 安装系统依赖
    # 优化构建命令以避免 metadata-generation-failed 错误
    # rootDir 已设置为 applications/scheduler，所以直接使用当前目录的 requirements.txt
    buildCommand: |
      # 检查 Python 版本，确保使用 3.11 而不是 3.13
      python --version
      if ! python --version | grep -q "3.11"; then
        echo "错误: 需要使用 Python 3.11，但检测到其他版本。请在 Render Dashboard 中设置 Python 版本为 3.11.0"
        exit 1
      fi
      # 升级 pip
      python -m pip install --upgrade pip setuptools wheel
      # 设置环境变量，明确告诉 pip 不要安装 pandas
      export PIP_NO_BUILD_ISOLATION=1
      # 使用最小化 requirements 文件，明确不包含 pandas
      # 如果安装过程中某个包尝试安装 pandas，pip 会因为找不到合适的版本而跳过
      pip install --no-cache-dir --no-build-isolation -r requirements-minimal.txt 2>&1 | grep -v "pandas" || {
        echo "安装过程中检测到 pandas 相关错误，尝试使用 --no-deps 方法"
        # 如果失败，使用 --no-deps 方法手动安装
        pip install --no-cache-dir --no-deps python-dotenv==1.0.0
        pip install --no-cache-dir --no-deps websockets==12.0
        pip install --no-cache-dir 'pydantic==1.10.13' || pip install --no-cache-dir 'pydantic>=1.10.0,<2.0'
        pip install --no-cache-dir --no-deps 'fastapi==0.104.1'
        pip install --no-cache-dir 'starlette>=0.27.0'
        pip install --no-cache-dir 'typing-extensions>=4.0.0' || true
        pip install --no-cache-dir --no-deps 'uvicorn==0.24.0'
        pip install --no-cache-dir 'h11>=0.8'
        pip install --no-cache-dir 'kafka-python-ng==2.2.3'
      }
      # 验证安装，确保没有 pandas
      pip list | grep -i pandas && (echo "警告: 检测到 pandas，卸载中..." && pip uninstall -y pandas numpy scipy scikit-learn 2>/dev/null || true) || echo "✓ 确认未安装 pandas"
    startCommand: python dispatch_center.py
    envVars:
      - key: CONFLUENT_BOOTSTRAP_SERVERS
        sync: false  # 需要在 Render Dashboard 中手动设置
      - key: CONFLUENT_API_KEY
        sync: false  # 需要在 Render Dashboard 中手动设置
      - key: CONFLUENT_API_SECRET
        sync: false  # 需要在 Render Dashboard 中手动设置
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: RUNTIME_VERSION
        value: python-3.11.0

