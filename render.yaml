services:
  # Dispatch Center Service (主服务)
  - type: web
    name: logistics-dispatch-center
    env: python
    region: oregon
    plan: free
    rootDir: applications/scheduler
    # Render 会自动读取 apt.txt 安装系统依赖
    # 优化构建命令以避免 metadata-generation-failed 错误
    # rootDir 已设置为 applications/scheduler，所以直接使用当前目录的 requirements.txt
    buildCommand: |
      python -m pip install --upgrade pip setuptools wheel
      # 明确使用当前目录（applications/scheduler）的 requirements.txt
      # 避免 Render 自动读取根目录包含 pandas 的 requirements.txt
      # 分步安装，确保每个包都成功安装
      pip install --no-cache-dir python-dotenv==1.0.0
      pip install --no-cache-dir websockets==12.0
      pip install --no-cache-dir 'pydantic==1.10.13' || pip install --no-cache-dir 'pydantic>=1.10.0,<2.0'
      pip install --no-cache-dir 'fastapi==0.104.1'
      pip install --no-cache-dir 'uvicorn==0.24.0'
      pip install --no-cache-dir 'kafka-python-ng==2.2.3'
      # 验证安装，确保没有 pandas
      pip list | grep -i pandas && echo "警告: 检测到 pandas" || echo "✓ 未安装 pandas"
    startCommand: python dispatch_center.py
    envVars:
      - key: CONFLUENT_BOOTSTRAP_SERVERS
        sync: false  # 需要在 Render Dashboard 中手动设置
      - key: CONFLUENT_API_KEY
        sync: false  # 需要在 Render Dashboard 中手动设置
      - key: CONFLUENT_API_SECRET
        sync: false  # 需要在 Render Dashboard 中手动设置
      - key: PYTHON_VERSION
        value: 3.11.0

